function init(){var e=document.getElementById("stage");e.oncontextmenu=function(){return!1},window.addEventListener("resize",resize);var t=[{src:"assets/tile_mask.png",id:"tile_mask"},{src:"assets/yellow/tile_yellow.png",id:"tile_yellow"},{src:"assets/yellow/server_yellow.png",id:"server_yellow"},{src:"assets/yellow/dome_yellow.png",id:"dome_yellow"},{src:"assets/blue/tile_blue.png",id:"tile_blue"},{src:"assets/blue/server_blue.png",id:"server_blue"},{src:"assets/blue/dome_blue.png",id:"dome_blue"},{src:"assets/gray/tile_gray.png",id:"tile_gray"},{src:"assets/gray/server_gray.png",id:"server_gray"},{src:"assets/gray/dome_gray.png",id:"dome_gray"},{src:"assets/red/tile_red.png",id:"tile_red"},{src:"assets/red/server_red.png",id:"server_red"},{src:"assets/red/dome_red.png",id:"dome_red"},{src:"assets/tile_empty.png",id:"tile_empty"},{src:"assets/animations/pulsate.json",id:"pulsate_data"},{src:"assets/animations/pulsate_reverse.json",id:"pulsate_reverse_data"},{src:"assets/animations/circle_dark.json",id:"circle_dark_data"}];loader=new createjs.LoadQueue(!1),loader.addEventListener("complete",onLoad),loader.loadManifest(t)}function onLoad(){stage=new createjs.Stage("stage"),cam=new createjs.Container,stage.addChild(cam),cam.scaleX=cam.scaleY=.75,resize(),map=new createjs.Container,cam.addChild(map),stage.enableMouseOver(),w=stage.canvas.width,h=stage.canvas.height,stage.addEventListener("stagemousedown",onMouseDown),stage.addEventListener("stagemouseup",onMouseUp),stage.addEventListener("stagemousemove",onMouseMove),maskBounds=new createjs.Bitmap(loader.getResult("tile_mask")).getBounds();for(var e=0;12>e;++e)for(var t=1;15>t;++t){var r,o=Math.round(4*Math.random());switch(o){case 0:r="gray";break;case 1:r="yellow";break;case 2:r="blue";break;case 3:r="red"}var a=new Datacenter(r,t,e);a.on("rollover",function(){this.on("tick",oscillate)}),a.on("rollout",function(){console.log(this)}),a.on("click",function(e){0===e.nativeEvent.button&&console.log(map.getChildIndex(this))})}var n=new Datacenter("blue",25,0);createjs.Ticker.timingMode=createjs.Ticker.RAF_SYNCHED,createjs.Ticker.setFPS(60),createjs.Ticker.addEventListener("tick",onTick)}function onTick(e){sortDraw&&(map.sortChildren(sortByRow),sortDraw=!1),stage.update(e)}function onMouseDown(e){var t=map.globalToLocal(e.stageX,e.stageY);currentCoord=pointToCoord(t),currentTile=getTile(currentCoord.q,currentCoord.r),0===e.nativeEvent.button&&(drawing=!0,connectionPath=[JSON.stringify(pointToCoord(t))]),2===e.nativeEvent.button&&(dragging=!0,dragOrigin={x:e.stageX-map.x*cam.scaleX,y:e.stageY-map.y*cam.scaleX}),console.log(pointToCoord(t))}function onMouseUp(e){0===e.nativeEvent.button&&(drawing=!1,connectionPath=_.map(connectionPath,function(e){return JSON.parse(e)}),console.log(JSON.stringify(connectionPath))),2===e.nativeEvent.button&&(dragging=!1)}function onMouseMove(e){var t=map.globalToLocal(e.stageX,e.stageY);if(currentCoord=pointToCoord(t),currentTile=getTile(currentCoord.q,currentCoord.r),JSON.stringify(prevCoord)!=JSON.stringify(currentCoord)&&(map.removeChild(emptytile),!currentTile)){console.log("empty"),emptytile=new createjs.Container,emptytile.addChild(new createjs.Bitmap(loader.getResult("tile_empty")));var r=coordToPoint({q:currentCoord.q,r:currentCoord.r});emptytile.x=r.x,emptytile.y=r.y,emptytile.q=currentCoord.q,emptytile.r=currentCoord.r,emptytile.alpha=1,emptytile.on("tick",oscillate),map.addChild(emptytile),sortDraw=!0}drawing&&(_.contains(connectionPath,JSON.stringify(currentCoord))||connectionPath.push(JSON.stringify(currentCoord))),dragging&&(map.x=(e.stageX-dragOrigin.x)/cam.scaleX,map.y=(e.stageY-dragOrigin.y)/cam.scaleY),prevCoord=currentCoord}function getTile(e,t){return tiles[e]?tiles[e][t]:null}function coordToPoint(e){return point={},point.x=e.q*maskBounds.width*3/4,point.y=e.r*maskBounds.height+e.q%2*maskBounds.height/2,point}function pointToCoord(e){coord={},coord.q=Math.floor(e.x/(3*maskBounds.width/4)),coord.r=Math.floor(e.y/maskBounds.height);for(var t=-1;1>=t;++t)for(var r=-1;1>=r;++r){var o=new createjs.Container,a=new createjs.Bitmap(loader.getResult("tile_mask"));o.hitArea=a;var n={q:coord.q+r,r:coord.r+t},s=coordToPoint(n);if(o.x=s.x,o.y=s.y,map.addChild(o),o.on("rollover",function(){}),_.contains(map.getObjectsUnderPoint(e.x,e.y),o))return map.removeChild(o),n;map.removeChild(o)}}function sortByRow(e,t){var r=2e4*e.r+1e4*!(e.q%2==0)+e.q,o=2e4*t.r+1e4*!(t.q%2==0)+t.q;return o>r?-1:r>o?1:0}function oscillate(e){_.each(this.children,function(e){e.y=8*-Math.sin(createjs.Ticker.getTime()/500)})}function resize(){stage.canvas.width=document.body.clientWidth,stage.canvas.height=document.body.clientHeight,cam.x=stage.canvas.width/2,cam.y=stage.canvas.height/2}var stage,w,h,loader,cam,map,maskBounds,dragOrigin,currentTile,currentCoord,prevCoord,drawing=dragging=!1,connectionPath,emptytile,sortDraw=!0,tiles={};init();